<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guardian Prompt Editor (Lightweight)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 40px);
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            text-align: center;
        }

        header h1 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        header p {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .controls {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .file-group {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        input[type="file"] {
            padding: 6px;
            border: 2px solid #667eea;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            padding: 8px;
            border: 2px solid #667eea;
            border-radius: 5px;
            font-size: 13px;
        }

        .stats {
            margin-left: auto;
            font-weight: 600;
            color: #495057;
            font-size: 13px;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .list-panel {
            width: 350px;
            border-right: 2px solid #e9ecef;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .list-item {
            padding: 12px 15px;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
            transition: background 0.2s;
        }

        .list-item:hover {
            background: #e9ecef;
        }

        .list-item.active {
            background: #667eea;
            color: white;
        }

        .list-item-title {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 12px;
        }

        .list-item-preview {
            font-size: 11px;
            color: #6c757d;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .list-item.active .list-item-preview {
            color: rgba(255,255,255,0.8);
        }

        .editor-panel {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .prompt-editor {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            border-right: 2px solid #e9ecef;
        }

        .output-selector {
            width: 400px;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: #495057;
            font-size: 13px;
        }

        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            resize: vertical;
            transition: border-color 0.3s;
        }

        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group select {
            width: 100%;
            padding: 8px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-size: 13px;
            transition: border-color 0.3s;
        }

        .editor-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #e9ecef;
        }

        .output-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .output-item {
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .output-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .output-item.selected {
            border-color: #667eea;
            background: #e7f3ff;
        }

        .output-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .output-risk {
            font-weight: 600;
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 3px;
            background: #e9ecef;
        }

        .output-risk.CRITICAL {
            background: #dc3545;
            color: white;
        }

        .output-risk.HIGH {
            background: #fd7e14;
            color: white;
        }

        .output-risk.MEDIUM {
            background: #ffc107;
            color: #000;
        }

        .output-risk.LOW {
            background: #28a745;
            color: white;
        }

        .output-type {
            font-size: 11px;
            color: #6c757d;
            font-weight: 600;
        }

        .output-preview {
            font-size: 11px;
            color: #495057;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .category-filter {
            margin-bottom: 15px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #495057;
            font-size: 16px;
        }

        .empty-state p {
            font-size: 13px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid #dee2e6;
        }

        .filter-group {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .filter-group select {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üõ°Ô∏è Guardian Prompt Editor</h1>
            <p>Lightweight modular editor for Guardian AI training prompts</p>
        </header>

        <div class="controls">
            <button class="btn btn-info" onclick="loadAllFiles()">üìÇ Load All Files</button>
            <button class="btn btn-success" onclick="createNew()">‚ûï New Prompt</button>
            <button class="btn btn-secondary" onclick="downloadPrompts()">üíæ Save Prompts</button>
            <button class="btn btn-info" onclick="buildDataset()">üî® Build Dataset</button>
            <input type="text" class="search-box" id="searchBox" placeholder="Search prompts..." onkeyup="searchPrompts()" />
            <span class="stats" id="stats">No files loaded</span>
        </div>

        <div class="main-content">
            <div class="list-panel" id="listPanel">
                <div class="empty-state">
                    <h3>No files loaded</h3>
                    <p>Click "Load All Files" to get started</p>
                </div>
            </div>

            <div class="editor-panel">
                <div class="prompt-editor" id="promptEditor">
                    <div class="empty-state">
                        <h3>Select a prompt</h3>
                        <p>Choose a prompt from the list or create a new one</p>
                    </div>
                </div>

                <div class="output-selector" id="outputSelector">
                    <div class="section-title">üì§ Output Templates</div>
                    <div class="filter-group">
                        <select id="categoryFilter" onchange="filterOutputs()">
                            <option value="">All Categories</option>
                        </select>
                        <select id="riskFilter" onchange="filterOutputs()">
                            <option value="">All Risk Levels</option>
                            <option value="CRITICAL">Critical</option>
                            <option value="HIGH">High</option>
                            <option value="MEDIUM">Medium</option>
                            <option value="LOW">Low</option>
                        </select>
                    </div>
                    <div class="output-list" id="outputList">
                        <div class="empty-state">
                            <p>Load files to see outputs</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let instructions = [];
        let prompts = [];
        let outputs = [];
        let filteredPrompts = [];
        let filteredOutputs = [];
        let currentIndex = -1;
        let selectedOutputId = null;

        async function loadAllFiles() {
            try {
                // Load instructions
                const instructionsResp = await fetch('instructions.jsonl');
                const instructionsText = await instructionsResp.text();
                instructions = instructionsText.split('\n')
                    .filter(line => line.trim())
                    .map(line => JSON.parse(line));

                // Load prompts
                const promptsResp = await fetch('prompts.jsonl');
                const promptsText = await promptsResp.text();
                prompts = promptsText.split('\n')
                    .filter(line => line.trim())
                    .map(line => JSON.parse(line));

                // Load outputs
                const outputsResp = await fetch('outputs.jsonl');
                const outputsText = await outputsResp.text();
                outputs = outputsText.split('\n')
                    .filter(line => line.trim())
                    .map(line => JSON.parse(line));

                filteredPrompts = [...prompts];
                filteredOutputs = [...outputs];

                // Populate category filter
                const categories = [...new Set(outputs.map(o => o.situation_type))].sort();
                const categoryFilter = document.getElementById('categoryFilter');
                categoryFilter.innerHTML = '<option value="">All Categories</option>' +
                    categories.map(cat => `<option value="${cat}">${cat.replace(/_/g, ' ').toUpperCase()}</option>`).join('');

                updateStats();
                renderPromptList();
                renderOutputList();

                if (prompts.length > 0) {
                    selectPrompt(0);
                }

                alert('‚úÖ All files loaded successfully!');
            } catch (error) {
                alert('‚ùå Error loading files: ' + error.message + '\n\nMake sure instructions.jsonl, prompts.jsonl, and outputs.jsonl are in the same directory as this HTML file.');
            }
        }

        function updateStats() {
            document.getElementById('stats').textContent =
                `${filteredPrompts.length} prompts | ${outputs.length} outputs`;
        }

        function renderPromptList() {
            const listPanel = document.getElementById('listPanel');

            if (filteredPrompts.length === 0) {
                listPanel.innerHTML = `
                    <div class="empty-state">
                        <h3>No prompts found</h3>
                        <p>Try a different search or create a new prompt</p>
                    </div>
                `;
                return;
            }

            listPanel.innerHTML = filteredPrompts.map((prompt, index) => {
                const originalIndex = prompts.indexOf(prompt);
                const preview = prompt.text.substring(0, 80).replace(/\n/g, ' ');
                return `
                    <div class="list-item ${currentIndex === originalIndex ? 'active' : ''}"
                         onclick="selectPrompt(${originalIndex})">
                        <div class="list-item-title">${prompt.id}</div>
                        <div class="list-item-preview">${preview}...</div>
                    </div>
                `;
            }).join('');
        }

        function renderOutputList() {
            const outputList = document.getElementById('outputList');

            if (filteredOutputs.length === 0) {
                outputList.innerHTML = `
                    <div class="empty-state">
                        <p>No outputs match filters</p>
                    </div>
                `;
                return;
            }

            outputList.innerHTML = filteredOutputs.map(output => {
                const preview = output.text.substring(0, 100).replace(/\n/g, ' ');
                return `
                    <div class="output-item ${selectedOutputId === output.id ? 'selected' : ''}"
                         onclick="selectOutput('${output.id}')">
                        <div class="output-item-header">
                            <span class="output-risk ${output.risk_level}">${output.risk_level}</span>
                            <span class="output-type">${output.situation_type.replace(/_/g, ' ')}</span>
                        </div>
                        <div class="output-preview">${preview}...</div>
                    </div>
                `;
            }).join('');
        }

        function selectPrompt(index) {
            currentIndex = index;
            const prompt = prompts[index];
            selectedOutputId = prompt.output_id;

            const instruction = instructions.find(i => i.id === prompt.instruction_template);

            const promptEditor = document.getElementById('promptEditor');
            promptEditor.innerHTML = `
                <div class="form-group">
                    <label>üìã Instruction Template</label>
                    <select id="instructionTemplate">
                        ${instructions.map(inst =>
                            `<option value="${inst.id}" ${inst.id === prompt.instruction_template ? 'selected' : ''}>
                                ${inst.id}
                            </option>`
                        ).join('')}
                    </select>
                </div>

                <div class="form-group">
                    <label>üí¨ User Prompt/Observation</label>
                    <textarea id="promptText" rows="10">${prompt.text}</textarea>
                </div>

                <div class="form-group">
                    <label>üîó Linked Output</label>
                    <input type="text" value="${selectedOutputId || 'None selected'}" readonly
                           style="width: 100%; padding: 8px; border: 2px solid #dee2e6; border-radius: 5px; background: #f8f9fa;" />
                </div>

                <div class="editor-actions">
                    <button class="btn btn-primary" onclick="savePrompt()">üíæ Save</button>
                    <button class="btn btn-danger" onclick="deletePrompt()">üóëÔ∏è Delete</button>
                    <button class="btn btn-secondary" onclick="duplicatePrompt()">üìã Duplicate</button>
                </div>
            `;

            renderPromptList();
            renderOutputList();
        }

        function selectOutput(outputId) {
            selectedOutputId = outputId;
            renderOutputList();
        }

        function savePrompt() {
            if (currentIndex === -1) return;

            const promptText = document.getElementById('promptText').value;
            const instructionTemplate = document.getElementById('instructionTemplate').value;

            prompts[currentIndex] = {
                ...prompts[currentIndex],
                text: promptText,
                instruction_template: instructionTemplate,
                output_id: selectedOutputId
            };

            filteredPrompts = [...prompts];
            renderPromptList();
            alert('‚úÖ Prompt saved!');
        }

        function createNew() {
            const newPrompt = {
                id: `prompt_${Date.now()}`,
                text: '',
                instruction_template: instructions[0]?.id || 'template_1',
                output_id: null
            };

            prompts.push(newPrompt);
            filteredPrompts = [...prompts];
            updateStats();
            selectPrompt(prompts.length - 1);
        }

        function duplicatePrompt() {
            if (currentIndex === -1) return;

            const currentPrompt = prompts[currentIndex];
            const duplicated = {
                ...currentPrompt,
                id: `prompt_${Date.now()}`
            };

            prompts.push(duplicated);
            filteredPrompts = [...prompts];
            updateStats();
            selectPrompt(prompts.length - 1);
        }

        function deletePrompt() {
            if (currentIndex === -1) return;

            if (!confirm('Delete this prompt?')) return;

            prompts.splice(currentIndex, 1);
            filteredPrompts = [...prompts];
            updateStats();

            if (prompts.length > 0) {
                selectPrompt(Math.min(currentIndex, prompts.length - 1));
            } else {
                currentIndex = -1;
                document.getElementById('promptEditor').innerHTML = `
                    <div class="empty-state">
                        <h3>No prompts</h3>
                        <p>Create a new prompt to get started</p>
                    </div>
                `;
                renderPromptList();
            }
        }

        function searchPrompts() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();

            if (!searchTerm) {
                filteredPrompts = [...prompts];
            } else {
                filteredPrompts = prompts.filter(prompt =>
                    prompt.text.toLowerCase().includes(searchTerm) ||
                    prompt.id.toLowerCase().includes(searchTerm)
                );
            }

            updateStats();
            renderPromptList();
        }

        function filterOutputs() {
            const category = document.getElementById('categoryFilter').value;
            const risk = document.getElementById('riskFilter').value;

            filteredOutputs = outputs.filter(output => {
                const matchCategory = !category || output.situation_type === category;
                const matchRisk = !risk || output.risk_level.includes(risk);
                return matchCategory && matchRisk;
            });

            renderOutputList();
        }

        function downloadPrompts() {
            if (prompts.length === 0) {
                alert('No prompts to download!');
                return;
            }

            const jsonlContent = prompts.map(prompt => JSON.stringify(prompt)).join('\n');
            const blob = new Blob([jsonlContent], { type: 'application/jsonl' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = 'prompts.jsonl';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            alert('‚úÖ Prompts saved to prompts.jsonl!');
        }

        function buildDataset() {
            if (prompts.length === 0 || instructions.length === 0 || outputs.length === 0) {
                alert('Load all files first!');
                return;
            }

            alert('‚ö†Ô∏è To build the full dataset, run the build-dataset.bat script.\n\nThis will combine instructions.jsonl, prompts.jsonl, and outputs.jsonl into a new guardian-alpaca-built.jsonl file.');
        }
    </script>
</body>
</html>
